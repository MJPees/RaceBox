unsigned char ReadMulti[10] = {0XAA,0X00,0X27,0X00,0X03,0X22,0XFF,0XFF,0X4A,0XDD};
unsigned int timeSec = 0;
unsigned int timemin = 0;
unsigned int dataAdd = 0;
unsigned int incomedate = 0;
unsigned int parState = 0;
unsigned int codeState = 0;
byte epc_bytes[12] = {0,0,0,0,0,0,0,0,0,0,0,0};
String last_epc_string = "";
unsigned long last_epc_read = 0;

#define MIN_LAP_MS 3000 //min time between laps

void setup() {
  Serial.begin(115200);
  Serial2.begin(115200,SERIAL_8N1, 16, 17);
  Serial.println("Hello world.");
  Serial2.write(ReadMulti,10);
}

void check_rfid(byte epc_bytes[]) {
  char buffer[25]; // Genug Platz für 8 Hex-Ziffern + Nullterminator
  // Konvertiere die Byte-Werte in hexadezimale Zeichen und speichere sie in epc_bytes
  for (int i = 0; i < 12; i++) {
    sprintf(buffer + (i * 2), "%02X", epc_bytes[i]);
  }
  buffer[24] = '\0'; // Nullterminator am Ende hinzufügen
  String epc_string(buffer);
  if(epc_string != last_epc_string || (last_epc_read + MIN_LAP_MS) < millis()) {
    Serial.print(epc_string);
    Serial.print(" => ");
    Serial.println(millis());
    last_epc_string = epc_string;
    last_epc_read = millis();
  }
}

void loop() { 
  if(Serial2.available() > 0)
  {
    incomedate = Serial2.read();
    if((incomedate == 0x02)&(parState == 0))
    {
      parState = 1;
    }
    else if((parState == 1)&(incomedate == 0x22)&(codeState == 0)){  
        codeState = 1;
        dataAdd = 3;
    }
    else if(codeState == 1){
      dataAdd ++;
      if(dataAdd == 6)
      {
        #ifdef DEBUG)
          Serial.print("RSSI:"); 
          Serial.println(incomedate, HEX);
        #endif 
        }
       #ifdef DEBUG
        else if((dataAdd == 7)|(dataAdd == 8)){
          
          if(dataAdd == 7){
            Serial.print("PC:"); 
            Serial.print(incomedate, HEX);
        }
        else {
           Serial.println(incomedate, HEX);
        }
       }
       #endif
       else if((dataAdd >= 9)&(dataAdd <= 20)){
        if(dataAdd == 9){
          Serial.print("EPC:"); 
        }        
        Serial.print(incomedate, HEX);
        epc_bytes[dataAdd -9] = incomedate;
       }
       else if(dataAdd >= 21){
        Serial.println();
        check_rfid(epc_bytes);
        dataAdd= 0;
        parState = 0;
        codeState = 0;
        }
    }
     else{
      dataAdd= 0;
      parState = 0;
      codeState = 0;
    }
  }
}
